<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="dongkw"><meta name="copyright" content="dongkw"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>jvm学习《深入理解java虚拟机》读书笔记（2）垃圾回收 | Hexo</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="none" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.19/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_stqaphw3j4.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/dongkw.github.io/yun.svg"><link rel="mask-icon" href="/dongkw.github.io/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/dongkw.github.io/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/dongkw.github.io/js/utils.js" as="script"><link rel="preload" href="/dongkw.github.io/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/dongkw.github.io/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/dongkw.github.io/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"root":"/dongkw.github.io/","title":"克威的小小地盘","version":"1.0.0","anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="哪些内存需要回收？ 什么时候回收？ 如何回收?">
<meta property="og:type" content="article">
<meta property="og:title" content="jvm学习《深入理解java虚拟机》读书笔记（2）垃圾回收">
<meta property="og:url" content="http://dongkw.github.io/2020/03/18/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="哪些内存需要回收？ 什么时候回收？ 如何回收?">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dongkw.github.io/images/mark-sweep.png">
<meta property="og:image" content="http://dongkw.github.io/images/copying.png">
<meta property="og:image" content="http://dongkw.github.io/images/markcompact.png">
<meta property="og:image" content="http://dongkw.github.io/images/serial.svg">
<meta property="og:image" content="http://dongkw.github.io/images/parnew.svg">
<meta property="og:image" content="http://dongkw.github.io/images/CMS.svg">
<meta property="article:published_time" content="2020-03-17T16:00:00.000Z">
<meta property="article:modified_time" content="2020-09-22T01:34:52.897Z">
<meta property="article:author" content="dongkw">
<meta property="article:tag" content="java">
<meta property="article:tag" content="jvm">
<meta property="article:tag" content="gc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dongkw.github.io/images/mark-sweep.png"><script src="/dongkw.github.io/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/dongkw.github.io/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/dongkw.github.io/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/dongkw.github.io/about/" title="dongkw"><img width="96" loading="lazy" src="/dongkw.github.io/images/avatar.jpeg" alt="dongkw"></a><div class="site-author-name"><a href="/dongkw.github.io/about/">dongkw</a></div><a class="site-name" href="/dongkw.github.io/about/site.html">Hexo</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/dongkw.github.io/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/dongkw.github.io/archives" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">27</span></a></div><div class="site-state-item"><a href="/dongkw.github.io/categories" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">16</span></a></div><div class="site-state-item"><a href="/dongkw.github.io/tags" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">23</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://github.com/dongkw" title="git"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://shang.qq.com/wpa/qunwpa?idkey=c929e704022704d8cced9ec355d44a3fa7ad34aea12cef1de03d75d3d7d5b059" title="QQ 群" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/dongkw" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/YunYouJun" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/elpsycn" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/dongkw.github.io/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E8%A6%81%E5%AD%98%E6%B4%BB"><span class="toc-number">1.</span> <span class="toc-text">第一步 判断对象是否要存活</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%AE%97%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">引用计数算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95-JAVA-C"><span class="toc-number">1.2.</span> <span class="toc-text">根搜索算法 JAVA C#</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%95%E4%B8%BA%E5%BC%95%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">何为引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%AD%98%E8%BF%98%E6%98%AF%E6%AD%BB%E4%BA%A1%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">生存还是死亡？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">垃圾回收算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0-%E6%B8%85%E9%99%A4%E7%AE%97%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">标记-清除算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">复制算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0-%E6%95%B4%E7%90%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.3.</span> <span class="toc-text">标记-整理算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.4.</span> <span class="toc-text">分代收集算法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">垃圾回收器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Serial%E6%94%B6%E9%9B%86%E5%99%A8-%EF%BC%88stop-the-world%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">Serial收集器 （stop the world）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ParNew%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">ParNew收集器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parallel-Scavenge-%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.3.</span> <span class="toc-text">Parallel Scavenge 收集器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serial-Old%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.4.</span> <span class="toc-text">Serial Old收集器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parallel-Old%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.5.</span> <span class="toc-text">Parallel Old收集器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CMS%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.6.</span> <span class="toc-text">CMS收集器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#G1%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">3.7.</span> <span class="toc-text">G1收集器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">4.</span> <span class="toc-text">内存分配策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BC%98%E5%85%88%E5%9C%A8Eden%E5%88%86%E9%85%8D"><span class="toc-number">4.1.</span> <span class="toc-text">对象优先在Eden分配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E5%AF%B9%E8%B1%A1%E4%B9%8B%E9%97%B4%E8%BF%9B%E5%85%A5%E8%80%81%E5%B9%B4%E4%BB%A3"><span class="toc-number">4.2.</span> <span class="toc-text">大对象之间进入老年代</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E6%9C%9F%E5%AD%98%E6%B4%BB%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%BF%9B%E5%85%A5%E8%80%81%E5%B9%B4%E4%BB%A3"><span class="toc-number">4.3.</span> <span class="toc-text">长期存活的对象进入老年代</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%AF%B9%E8%B1%A1%E5%B9%B4%E9%BE%84%E5%88%A4%E6%96%AD"><span class="toc-number">4.4.</span> <span class="toc-text">动态对象年龄判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E6%8B%85%E4%BF%9D"><span class="toc-number">4.5.</span> <span class="toc-text">空间分配担保</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://dongkw.github.io/dongkw.github.io/2020/03/18/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="dongkw"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Hexo"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">jvm学习《深入理解java虚拟机》读书笔记（2）垃圾回收</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2020-03-18 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-18T00:00:00+08:00">2020-03-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2020-09-22 09:34:52" itemprop="dateModified" datetime="2020-09-22T09:34:52+08:00">2020-09-22</time></div><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/dongkw.github.io/categories/java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">java</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/dongkw.github.io/tags/java/" style="--text-color:#0E83CD"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">java</span></a><a class="tag" href="/dongkw.github.io/tags/jvm/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">jvm</span></a><a class="tag" href="/dongkw.github.io/tags/gc/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">gc</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><ol>
<li>哪些内存需要回收？</li>
<li>什么时候回收？</li>
<li>如何回收?<a id="more"></a> 

</li>
</ol>
<h1 id="第一步-判断对象是否要存活"><a href="#第一步-判断对象是否要存活" class="headerlink" title="第一步 判断对象是否要存活"></a>第一步 判断对象是否要存活</h1><h2 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h2><p>首先给对象添加一个引用计数器 如果有人引用了这个对象 计数器加1 ，<br>当引用失效时 计数器减一；任何时刻计数器都为0的对象就是不能被使用的。</p>
<p>优点：实现简单 效率高<br>缺点：很难解决对象循环引用的问题 A引用B B的计数器加一 B也引用A A的计数器加一 AB的就都不为1 但实际上两个对象都没用</p>
<h2 id="根搜索算法-JAVA-C"><a href="#根搜索算法-JAVA-C" class="headerlink" title="根搜索算法 JAVA C#"></a>根搜索算法 JAVA C#</h2><p>通过一系列名为 “GC Roots”的对象作为起点 从这些节点向下搜索，搜索走过的路径称为引用链，<br>当一个对象对到GC Roots没有任何引用链相连时 （GC Roots 到这个对象不可达），证明对象不可用</p>
<p>Java中 GC Roots对象包括 </p>
<ol>
<li>虚拟机栈（<code>本地变量表</code>）中的引用对象</li>
<li>方法区中<code>静态类属</code>性引用的对象</li>
<li>方法区中<code>常量</code>引用的对象</li>
<li>本地方法栈中<code>JNI</code> (Native方法)的引用对象</li>
</ol>
<h2 id="何为引用"><a href="#何为引用" class="headerlink" title="何为引用"></a>何为引用</h2><p>如果reference类型的数据中存储的数值是另一块内存的起始地址，就称这块内存代表这一个引用。</p>
<ol>
<li>强引用 类似 Object obj=new Object() 只要强引用还存在，垃圾回收永远不会回收被引用的对象。</li>
<li>软引用 还有用 并非必须 在系统将要发生内存溢出时，将会把这些对象列进回收范围并进行二次回收。</li>
<li>弱引用 非必须对象 被弱引用的对象只能生存到下一次垃圾收集发生之前。</li>
<li>虚引用 一个对象是否有虚引用的存在，完全不会对其生存时间产生影响，也无法通过虚引用来获取一个对象实例。</li>
</ol>
<h2 id="生存还是死亡？"><a href="#生存还是死亡？" class="headerlink" title="生存还是死亡？"></a>生存还是死亡？</h2><p>真正需要回收到对象需要经过两次标记</p>
<p>方法区 垃圾回收性价比低 两个内容 废弃的常量，无用的类。</p>
<ol>
<li>废弃的常量 没有引用。</li>
<li>无用的类 该类所有实例都被回收 加载该类的ClassLoader已经被回收 没有任何地方引用 无法通过反射访问该类方法。</li>
</ol>
<p>大量使用反射 动态代理 CGLib 等 bytecode框架的场景 以及频繁自定义ClassLoader的场景都需要具备类卸载功能。</p>
<h1 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h1><h2 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h2><p><img src="/images/mark-sweep.png" loading="lazy"></p>
<p>标记清除法是最基础的算法 分为两个阶段 </p>
<ol>
<li>首先标记处所需要回收的对象</li>
<li>在完成标记后统一回收掉所有被标记的对象</li>
</ol>
<p>缺点 1. 效率问题 标记和清除效率不高 2. 空间问题 清除后会产生大量不了连续的空间碎片。</p>
<h2 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h2><p><img src="/images/copying.png" loading="lazy"></p>
<p>复制算法将可用的内存按容量分为大小相等的两块， 只使用其中一块，当使用完了以后把活着的对象复制到另外一块上，把已使用的内存空间全部清掉。</p>
<p>优点 实现简单 运行高效<br>缺点 把内存缩小为原来的一半</p>
<p>复制算法用来回收新生代。</p>
<p>新生代中的对象98%朝生夕死 所有并不需要有按1：1 比例分配空间 </p>
<p>新生代分为Eden 空间和两块较小的Survivor空间 每次用Eden 和一个Survivor 。<br>回收时把Eden 与Survivor的活着的对象一次性拷贝到另一款Survivor上 最后清理掉Eden 与Survivor空间。</p>
<h2 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h2><p><img src="/images/markcompact.png" loading="lazy"></p>
<p>标记整理算法是把存活的对象都向一段移动，然后清理掉边界以外的内存。</p>
<h2 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h2><p>根据对象的存活周期不同将内存分为几块，一般分为新生代和老年代，这样可以根据各个代的特点采取最适当的手机算法。</p>
<p>新生代采取复制算法 </p>
<p>老年代采取标记清理或标记整理算法。</p>
<h1 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h1><p>收集算法是内存回收的方法论，垃圾回收器就是内存回收的具体实现。</p>
<h2 id="Serial收集器-（stop-the-world）"><a href="#Serial收集器-（stop-the-world）" class="headerlink" title="Serial收集器 （stop the world）"></a>Serial收集器 （stop the world）</h2><p><img src="/images/serial.svg" loading="lazy"></p>
<p>Serial收集器是新生代收集器，是单线程收集器，在垃圾回收的同时会暂停掉所有工作线程。</p>
<p>虽然会停掉其他所有工作线程 但是有显著的有点 简单高效，目前在client模式下的虚拟机里还有应用。</p>
<h2 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h2><p><img src="/images/parnew.svg" loading="lazy"></p>
<p>ParNew收集器是serial收集器的多线程版本，除了多线程外和secrial完全一样。</p>
<p>是server模式下虚拟机中首选新生代收集器 因为除了serial收集器 只有它能和CMS收集器配合。</p>
<h2 id="Parallel-Scavenge-收集器"><a href="#Parallel-Scavenge-收集器" class="headerlink" title="Parallel Scavenge 收集器"></a>Parallel Scavenge 收集器</h2><p>Parallel Scavenge 收集器是也新生代收集器，也使用复制算法，是并行多线程收集器。</p>
<p>Parallel Scavenge收集器目的但是达到一个可控吞吐量，代码运行时间/(gc时间+代码运行时间)。</p>
<p>主要是为了给虚拟机设定一个可控目标，会自适应调节吞吐量。</p>
<h2 id="Serial-Old收集器"><a href="#Serial-Old收集器" class="headerlink" title="Serial Old收集器"></a>Serial Old收集器</h2><p>Serial Old收集器是Serial收集器的老年代版本，是 单线程收集器，使用标记整理算法。</p>
<p>主要意义是用在Client模式下。</p>
<h2 id="Parallel-Old收集器"><a href="#Parallel-Old收集器" class="headerlink" title="Parallel Old收集器"></a>Parallel Old收集器</h2><p>Parallel Old是Parallel Scavenge收集器的老年代版本，使用多线程和标记-整理算法。</p>
<h2 id="CMS收集器"><a href="#CMS收集器" class="headerlink" title="CMS收集器"></a>CMS收集器</h2><p><img src="/images/CMS.svg" loading="lazy"></p>
<p>CMS收集器是一种以获取最短收集停用时间为目标的收集器。基于标记清楚算法实现。</p>
<p>CMS收集器需要四个步骤</p>
<ol>
<li>初始标记 只是标记一下CG Roots直接关联到的对象，速度快。</li>
<li>并发标记 跟搜索算法（CG Roots Tracing）确定存活和死亡的对象。</li>
<li>重新标记 修正并发标记时间内程序导致标记变动的记录,需要时间但是比重新标记快。</li>
<li>并发清除 清除标记内容。</li>
</ol>
<p>初始标记，重新标记需要stop the world </p>
<p>优点:并发收集，低停顿</p>
<p>缺点:</p>
<ol>
<li>对CPU资源相对敏感 默认启动线程数为(CPU+3)/4。在GC期间降低工作效率。</li>
<li>无法处理浮动垃圾，初始标记和重新标记后会有浮动垃圾无法回收。</li>
<li>标记清楚算法会有大量碎片空间。</li>
</ol>
<h2 id="G1收集器"><a href="#G1收集器" class="headerlink" title="G1收集器"></a>G1收集器</h2><p>我理解的G1收集器是分区域、分先级，在规定时间内完成优先级最高的GC。</p>
<p>G1收集器是基于标记-整理算法实现的，不会产生碎片空间。</p>
<p>G1收集器能精确控制停顿时间，规定总时间M，GC时间N，毫秒级，无停顿。</p>
<p>G1收集器将整个java堆分成多个大小固定的独立区域（Region）,根据垃圾堆积数量，后台维护一个优先级列表，每次根据允许时间 优先回收垃圾最多的区域。</p>
<h1 id="内存分配策略"><a href="#内存分配策略" class="headerlink" title="内存分配策略"></a>内存分配策略</h1><p>java技术中自动化内存管理可以归结为自动化的解决了两个问题，<br>    1. 给对象分配内存<br>    2. 回收给对象分配的内存</p>
<h2 id="对象优先在Eden分配"><a href="#对象优先在Eden分配" class="headerlink" title="对象优先在Eden分配"></a>对象优先在Eden分配</h2><p>对象在新生代Eden中分配，没有足够空间时虚拟机将发起Minor GC。</p>
<p>Minor GC 新生代的垃圾回收动作，java对象大多生命周期短，Minor GC非常频繁，速度也比较快。</p>
<p>Full GC 老年代的垃圾回收，经常会伴随至少一次的MinorGC ,速度比MinorGC慢10倍以上。</p>
<h2 id="大对象之间进入老年代"><a href="#大对象之间进入老年代" class="headerlink" title="大对象之间进入老年代"></a>大对象之间进入老年代</h2><p>大对象是指需要大量连续内存空间的JAVA对象，放入老年代的目的是为了避免Eden和两个Survivor之间发生大内存拷贝。</p>
<p>所以要避免生命周期短的大对象，FullGC 慢。</p>
<h2 id="长期存活的对象进入老年代"><a href="#长期存活的对象进入老年代" class="headerlink" title="长期存活的对象进入老年代"></a>长期存活的对象进入老年代</h2><p>虚拟机采用分代收集思想，内存回收时就需要明确哪些对象放在新生代，哪些对象放在老年代。</p>
<p>对象年龄计数器 对象在Eden中经历Minor GC存活后转移到Survivor中，对象年龄加一，没过一次Minor GC 对象不死亡年龄加一，当年龄加到一定程度（默认15，可以设置）时移到老年代。</p>
<h2 id="动态对象年龄判断"><a href="#动态对象年龄判断" class="headerlink" title="动态对象年龄判断"></a>动态对象年龄判断</h2><p>15次是默认标准，但是如果Survivor区中的对象年龄普遍偏大（相同年龄的对象大小大于Survivor空间的一半），那就都移到老年代，给Survivor区域腾地方。</p>
<h2 id="空间分配担保"><a href="#空间分配担保" class="headerlink" title="空间分配担保"></a>空间分配担保</h2><p>发生minorGC时 会检查晋升到老年代的大小平均值是否大于老年代的剩余空间，如果直接进行一次Full GC,小于就看是否允许担保失败，如果允许就进行Minor GC 否则就进行Full GC。</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/dongkw.github.io/images/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechatpay.jpg"><img loading="lazy" src="/dongkw.github.io/images/wechatpay.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>dongkw</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://dongkw.github.io/2020/03/18/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" title="jvm学习《深入理解java虚拟机》读书笔记（2）垃圾回收">http://dongkw.github.io/2020/03/18/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless stating additionally.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/dongkw.github.io/2020/03/20/redis/" rel="prev" title="redis"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">redis</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/dongkw.github.io/2020/03/17/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="next" title="jvm学习 《深入理解java虚拟机》读书笔记（1）JAVA内存区域"><span class="post-nav-text">jvm学习 《深入理解java虚拟机》读书笔记（1）JAVA内存区域</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/dongkw/dongkw.github.io/issues?q=is:issue+jvm学习《深入理解java虚拟机》读书笔记（2）垃圾回收">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> dongkw</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.0.0</span></div><div id="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" title="Total Visitors"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="Total Views"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/dongkw.github.io/js/utils.js"></script><script defer src="/dongkw.github.io/js/hexo-theme-yun.js"></script><script src="/dongkw.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>